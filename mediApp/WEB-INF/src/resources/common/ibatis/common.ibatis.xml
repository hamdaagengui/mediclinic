<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<!--
	iBATIS SQL object - Relational mapping for Concurrent Data
	Includes SQL features: SELECT  -->
	

<sqlMap namespace="common">

	 <parameterMap id="Person-Details-Map"   class="java.util.HashMap">
	    <parameter property="Key"    	 		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Username"  		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="PersonType"   		javaType="java.lang.String"    mode="IN"/>	    
	 </parameterMap>
	 
	 <resultMap class="com.mediapp.domain.common.Person" id="Person-Details-Result-Map">
	 	<result property="idPerson" column="idPerson"/>
	 	<result property="firstName" column="first_name"/>
	 	<result property="lastName" column="last_name"/>
	 	<result property="middleInitial" column="middle_name"/>
	 	<result property="dateOfBirth" column="date_of_birth"/>
	 	<result property="gender" column="gender"/>
	 	<result property="landlinePhoneNumber" column="landline_phone_number"/>
	 	<result property="cellPhoneNumber" column="mobile_phone_number"/>
	 	<result property="emailID" column="email_address"/>
	 	<result property="accountStatus" column="status_of_account"/>
	 	<result property="personTypeString" column="person_type"/>
	 	<result property="password" column="ePassword"/>
	 	<result property="address.address1" column="address1" />
	 	<result property="address.address2" column="address2" />
	 	<result property="address.locality" column="locality" />
	 	<result property="address.city" column="city" />
	 	<result property="address.state" column="state" />
	 	<result property="address.country" column="country"/>
	 </resultMap>

	<select id="authenticateUser" parameterMap="Person-Details-Map" resultMap="Person-Details-Result-Map">
            SELECT person.idPerson,first_name,last_name,middle_name,
           date_of_birth, Gender, landline_phone_number, mobile_phone_number,
           email_address, status_of_account, person_type, AES_DECRYPT(password,?) as ePassword,
           address1, address2, locality, city, state, country
           FROM person left join address on address.personID = person.idPerson
           where 
		   email_address = ? and
		   person_type = ?;		   
 	</select>


	 <parameterMap id="Person-Type-Map"   class="java.util.HashMap">
	    <parameter property="Category"    		javaType="java.lang.String"    mode="IN"/>
	 </parameterMap>

	<select id="getPersonType" parameterMap="Person-Type-Map" resultClass="java.lang.String">
           SELECT code_val FROM code_decode where code_ctg = ?
 	</select>
	

	 <parameterMap id="eMail-Exists-Map"   class="java.util.HashMap">
	    <parameter property="emailID"    		javaType="java.lang.String"    mode="IN"/>
	 </parameterMap>


	<select id="checkeMailExists" parameterMap="eMail-Exists-Map" resultClass="java.lang.Integer">
           SELECT count(email_Address) FROM person where email_Address = ?
 	</select>


	<insert id="insertNewPerson">
		INSERT INTO person (idPerson, email_Address,status_of_account,person_type,password,mobile_phone_number ) 
		VALUES (nextval('seq_person_id'), #emailID#,'T',#personTypeString#,AES_ENCRYPT(#password#,#key#),#cellPhoneNumber# )
	</insert>
	
	<update id="updateProfile" >
		UPDATE person set first_name=#firstName#,last_name=#lastName#,middle_name=#middleInitial#,
		date_of_birth=date_format(#dateOfBirth#, '%y-%m-%d'),gender=#gender#,landline_phone_number=#landlinePhoneNumber#,mobile_phone_number=#cellPhoneNumber#
		where email_address=#username#
		and person_type=#personTypeString#	
	</update>
	
	<insert id="insertAddress" >
			insert into address (address1, address2, locality, city, state, country, personID) values
			(#address.address1#, #address.address2#, #address.locality#, #address.city#, #address.state#, #address.country#, #idPerson#)
			ON DUPLICATE KEY UPDATE updated = updated + 1;
	</insert>

 	<resultMap class="com.mediapp.domain.common.CodeDecode" id="Auto-Complete-Result-Map">
	 	<result property="codeDecode" column="code_val"/>
	 	<result property="codeDescription" column="code_desc"/>
	</resultMap>
	 	
	<parameterMap id="Auto-Complete-Map"   class="java.util.HashMap">
		<parameter property="Category"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Code"    		javaType="java.lang.String"    mode="IN"/>
	</parameterMap>

	<select id="autoComplete" parameterMap="Auto-Complete-Map" resultMap="Auto-Complete-Result-Map">
           SELECT code_val,code_desc FROM code_decode where code_ctg = ? and code_val like ?
 	</select>
 	
 	<resultMap class="com.mediapp.domain.common.SearchResult" id="Search-Result-Map">
 		<result property="idPerson" column="idPerson"/>
	 	<result property="doctorFirstName" column="first_name"/>
	 	<result property="doctorMiddleName" column="middle_name"/>
	 	<result property="doctorLastName" column="last_name"/>
	 	<result property="address1" column="address1"/>
	 	<result property="address2" column="address2"/>
	 	<result property="locality" column="Locality"/>
	 	<result property="city" column="City"/>
	 	<result property="state" column="State"/>
	 	<result property="country" column="Country"/>
	 	<result property="workStartTime" column="work_start_time"/>
	 	<result property="workEndTime" column="work_end_time"/>
	 	<result property="mondayWorking" column="monday_working"/>
	 	<result property="tuesdayWorking" column="tuesday_working"/>
	 	<result property="wednesdayWorking" column="wednesday_working"/>
	 	<result property="thursdayWorking" column="thursday_working"/>
	 	<result property="fridayWorking" column="friday_working"/>
	 	<result property="saturdayWorking" column="saturday_working"/>
	 	<result property="sundayWorking" column="sunday_working"/>	 	
	</resultMap>
	 	
	<parameterMap id="Search-Input-Map"   class="java.util.HashMap">
		<parameter property="MondayWorking"    	javaType="java.lang.String"    mode="IN"/>
		<parameter property="MondayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="TuesdayWorking"    javaType="java.lang.String"    mode="IN"/>
	    <parameter property="TuesdayWorking"    javaType="java.lang.String"    mode="IN"/>
	    <parameter property="WednesdayWorking"  javaType="java.lang.String"    mode="IN"/>
	    <parameter property="WednesdayWorking"  javaType="java.lang.String"    mode="IN"/>
	    <parameter property="ThursdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="ThursdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FridayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FridayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SaturdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SaturdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SundayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SundayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Locality"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Locality"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FirstName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FirstName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="LastName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="LastName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="MiddleInitial"		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="MiddleInitial"		javaType="java.lang.String"    mode="IN"/>	    
	</parameterMap>

	<select id="searchDoctor" parameterMap="Search-Input-Map" resultMap="Search-Result-Map">
			select p.idPerson, p.first_name,p.last_name, p.middle_name,
			dd.work_start_time, dd.work_end_time,
			monday_working, tuesday_working,
			wednesday_working, thursday_working,
			friday_working, saturday_working,
			sunday_working, address1,address2, Locality, City,State,Country
			from 
			person p,
			doctor_details dd,
			address a
			where p.idPerson = dd.idPerson
			and p.idPerson = a.personID			
			and (dd.monday_working = ? or ifnull(?,'')='')
            and (dd.tuesday_working  = ? or ifnull(?,'')='')
            and (dd.wednesday_working = ? or ifnull(?,'')='')
            and (dd.thursday_working = ? or ifnull(?,'')='')
            and (dd.friday_working = ? or ifnull(?,'')='')
            and (dd.saturday_working = ? or ifnull(?,'')='')
            and (dd.sunday_working = ? or ifnull(?,'')='')
            and (Locality =? or ifnull(?,'')='')
    		and (first_name = ? or ifnull(?,'')='')
    		and (last_name = ? or ifnull(?,'')='')
    		and (middle_name = ? or ifnull(?,'')='')        
            and person_type = 'Doctor' 	
      </select>

 	<resultMap class="com.mediapp.domain.common.Appointment" id="Day-Appointment-Result-Map">
	 	<result property="appointmentID" 		column="idAppointment_History"/> 	
	 	<result property="headline" 			column="appointment_headline"/>
	 	<result property="dateOfAppointment" 	column="date_of_appointment"/>
	 	<result property="timeOfAppointment" 	column="time_of_appointment"/>
	 	<result property="appointmentDuration" 	column="appointment_duration"/>
	 	<result property="doctorID" 			column="idDoctor_details"/>
	 	<result property="doctorWorkStartTime" 	column="work_start_time"/>
	 	<result property="doctorWorkEndTime" 	column="work_end_time"/>
	 	<result property="comments"			 	column="appointment_comment"/>
	</resultMap>
	 	
	<parameterMap id="Day-Appointment-Parm-Map"   class="java.util.HashMap">
		<parameter property="PersonID"    			javaType="java.lang.Integer"   	mode="IN"/>
	    <parameter property="DateOfAppointment"    	javaType="java.util.Date"   	mode="IN"/>
	    <parameter property="PersonID"    			javaType="java.lang.Integer"    mode="IN"/>
	</parameterMap>

	<select id="dayAppointment" parameterMap="Day-Appointment-Parm-Map" resultMap="Day-Appointment-Result-Map">
			select idAppointment_History, appointment_headline,date_of_appointment,time_of_appointment, appointment_duration,ah.idDoctor_details,work_start_time,work_end_time,appointment_comment
			from appointment_history ah,
			doctor_details dd,
			person p
			where 
			(p.person_type = 'Doctor' and dd.idPerson=p.idPerson and dd.idDoctor_details = ah.idDoctor_details) 
			and p.idPerson =?
			and date_of_appointment = date_format(?,'%Y-%m-%d')
			 union all
			select 0,'','9999-12-31','23:59:59', '23:59:59',idDoctor_details,work_start_time,work_end_time,''
			from doctor_details dd,
			person p
			where 
			(p.person_type = 'Doctor' and dd.idPerson=p.idPerson) 
			and p.idPerson =?
 	</select>

	<parameterMap id="Day-Appointment-Parm-Map"   class="java.util.HashMap">
		<parameter property="PersonID"    			javaType="java.lang.Integer"    mode="IN"/>	    
	</parameterMap>
	
	<insert id="insertNewAppointment">
		INSERT INTO appointment_history ( idPatient_details,idDoctor_details,date_of_appointment,appointment_type,
		appointment_confirmation,time_of_appointment,appointment_comment,appointment_duration,appointment_headline ) 
		VALUES ( (select idpatient_details from patient_details where idPerson=#doctorPersonID#),#doctorID#,#dateOfAppointment#,'R','N',
		#timeOfAppointment#,#comments#,#appointmentDuration# ,#headline#)
	</insert>
	
	 <parameterMap id="Personal-Details-Map"   class="java.util.HashMap">
		 <parameter property="PersonID"    	 		javaType="java.lang.Integer"    mode="IN"/>
	 </parameterMap>
	 
	 <resultMap class="com.mediapp.domain.common.Person" id="Personal-Details-Result-Map">
	 	<result property="idPerson" column="idPerson"/>
	 	<result property="firstName" column="first_name"/>
	 	<result property="lastName" column="last_name"/>
	 	<result property="middleInitial" column="middle_name"/>
	 	<result property="dateOfBirth" column="date_of_birth"/>
	 	<result property="gender" column="gender"/>
	 	<result property="landlinePhoneNumber" column="landline_phone_number"/>
	 	<result property="cellPhoneNumber" column="mobile_phone_number"/>
	 	<result property="emailID" column="email_address"/>
	 	<result property="accountStatus" column="status_of_account"/>
	 	<result property="personTypeString" column="person_type"/>
	 	<result property="address.address1" column="address1" />
	 	<result property="address.address2" column="address2" />
	 	<result property="address.locality" column="locality" />
	 	<result property="address.city" column="city" />
	 	<result property="address.state" column="state" />
	 	<result property="address.country" column="country"/>
	 	<result property="doctorDetails.registrationNumber" column="registration_id"/>
	 	<result property="doctorDetails.specialization" column="specialization"/>
	 	<result property="doctorDetails.idDoctor" column="idDoctor_details" />
	 </resultMap>

	<select id="getPersonalProfile" parameterMap="Personal-Details-Map" resultMap="Personal-Details-Result-Map">
            SELECT person.idPerson,first_name,last_name,middle_name,
           date_of_birth, Gender, landline_phone_number, mobile_phone_number,
           email_address, status_of_account, person_type, 
           address1, address2, locality, city, state, country,registration_id,specialization,ifnull(idDoctor_details,0) as idDoctor_details
           FROM person 
           left join address 
           on address.personID = person.idPerson
           left join doctor_details
           on person.idPerson = doctor_details.idPerson
           where 
		   person.idPerson=?;
	</select>
	
	<resultMap class="com.mediapp.domain.common.AppointmentTO" id="Get-Appointment-Result-Map">
		<result property="appointmentID" 				column="idAppointment_history"/>
	 	<result property="headline" 					column="appointment_headline"/>
	 	<result property="dateOfAppointment" 			column="date_of_appointment"/>
	 	<result property="timeOfAppointment" 			column="time_of_appointment"/>
	 	<result property="appointmentDuration" 			column="appointment_duration"/>
	 	<result property="doctorID" 					column="idDoctor_details"/>
	 	<result property="codeICD" 						column="ICD_code"/>
	 	<result property="prescription" 				column="Prescription"/>
	 	<result property="diagnosisTest" 				column="suggested_test"/>
	 	<result property="diagnosisTestResultUnit" 		column="test_result_value"/>
	 	<result property="diagnosisTestResultValue" 	column="test_result_unit"/>
	</resultMap>
	 	
	<parameterMap id="Get-Appointment-Parm-Map"   class="java.util.HashMap">
		<parameter property="AppointmentID"    			javaType="java.lang.Integer"   mode="IN"/>
	</parameterMap>

	<select id="getAppointment" parameterMap="Get-Appointment-Parm-Map" resultMap="Get-Appointment-Result-Map">
			select idAppointment_history,appointment_headline,date_of_appointment,time_of_appointment, appointment_duration,ah.idDoctor_details,
                    ICD_code,Prescription,suggested_test,test_result_value,test_result_unit				
			from person p
			left OUTER join doctor_details dd on dd.idPerson=p.idPerson
			left OUTER join appointment_history ah on 
				((p.person_type = 'Doctor' and dd.idPerson=p.idPerson and dd.idDoctor_details = ah.idDoctor_details) or
					(p.person_type = 'Patient' and dd.idPerson=p.idPerson and dd.idDoctor_details = ah.idDoctor_details) )
			left OUTER join diagnosis d on d.idAppointment = ah.idAppointment_History
			left OUTER join tests t on t.fDiagnosis= d.idDiagnosis
			where ah.idAppointment_History=?;
 	</select>

	<resultMap class="com.mediapp.domain.common.AppointmentForMonth" id="Get-MonthAppointment-Result-Map">
	 	<result property="dateOfAppointment" 	column="date_of_appointment"/>
	 	<result property="appointmentCount"		column="AppointmentCount"/>
	</resultMap>
	 	
	<parameterMap id="Get-MonthAppointment-Parm-Map"   class="java.util.HashMap">
		<parameter property="PersonID"    			javaType="java.lang.Integer"  		mode="IN"/>
	    <parameter property="DateOfAppointment"    	javaType="java.util.Date"   		mode="IN"/>
	    <parameter property="DateOfAppointment"    	javaType="java.util.Date"   		mode="IN"/>
		<parameter property="PersonID"    			javaType="java.lang.Integer"   		mode="IN"/>
	    <parameter property="DateOfAppointment"    	javaType="java.util.Date"   		mode="IN"/>
	    <parameter property="DateOfAppointment"    	javaType="java.util.Date"   		mode="IN"/>
	</parameterMap>

	<select id="getMonthAppointment" parameterMap="Get-MonthAppointment-Parm-Map" resultMap="Get-MonthAppointment-Result-Map">
		select date_of_appointment,count(date_of_appointment) as AppointmentCount
		from person p
		left OUTER join doctor_details dd on dd.idPerson=p.idPerson
		left OUTER join appointment_history ah on      
		(p.person_type = 'Doctor' and dd.idPerson=p.idPerson and dd.idDoctor_details = ah.idDoctor_details)
		where p.idPerson =?    and month(date_of_appointment) = month(?) 
		and year(date_of_appointment) = year(?)              
		group by date_of_appointment             
		union all
		select date_of_appointment,count(date_of_appointment)        
		from person p
		left OUTER join patient_details pd on pd.idPerson=p.idPerson    
		left OUTER join appointment_history ah on
		(p.person_type = 'Patient' and pd.idPerson=p.idPerson and pd.idPatient_details = ah.idPatient_details)     
		where p.idPerson =?     
		and month(date_of_appointment) = month(?)             
		and year(date_of_appointment) = year(?)              
		group by date_of_appointment; 
 	</select>

	 <parameterMap id="Bulk-Nextval-Parm-Map"   class="java.util.HashMap">
	    <parameter property="SequenceName" 		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="HowMuch"   		javaType="java.lang.Integer"   mode="IN"/>	    
	 </parameterMap>
	 
	<select id="bulkNextVal" parameterMap="Bulk-Nextval-Parm-Map" resultClass="java.lang.Integer">
			select bulknextval(?,?);
 	</select>

	 <parameterMap id="Insert-NewDiagnosis-Parm-Map"   class="java.util.HashMap">
	    <parameter property="DiagnosisID"   		javaType="java.lang.Integer"   	mode="IN"/>
	    <parameter property="AppointmentID" 		javaType="java.lang.Integer"    mode="IN"/>
		<parameter property="Prescription"   		javaType="java.lang.String"   	mode="IN"/>	    
		<parameter property="ICDCode"   			javaType="java.lang.String"   	mode="IN"/>			    
	 </parameterMap>
	
	<insert id="insertNewDiagnosis" parameterMap="Insert-NewDiagnosis-Parm-Map">
		INSERT INTO diagnosis (idDiagnosis, idAppointment,Prescription,ICD_code ) 
		VALUES (?,?,?,? )
	</insert>

	 <parameterMap id="Insert-NewTests-Parm-Map"   class="java.util.HashMap">
	    <parameter property="diagnosisTest" 			javaType="java.lang.String"    mode="IN"/>	    
		<parameter property="diagnosisTestResultValue"  javaType="java.lang.String"   	mode="IN"/>
		<parameter property="diagnosisTestResultUnit"   javaType="java.lang.String"   	mode="IN"/>
		<parameter property="DiagnosisID"   			javaType="java.lang.Integer"   	mode="IN"/>	    	    
	 </parameterMap>

	<insert id="insertNewTests" parameterMap="Insert-NewTests-Parm-Map">
		INSERT INTO tests (suggested_Test, test_Result_Value,test_Result_Unit,fDiagnosis ) 
		VALUES (?,?,?,?)
	</insert>

	 <parameterMap id="Insert-ScheduleJob-Parm-Map"   class="java.util.HashMap">
		<parameter property="ScheduleID" 		javaType="java.lang.Integer"    mode="IN"/>	 
	    <parameter property="Action" 			javaType="java.lang.String"    mode="IN"/>	    
		<parameter property="Comments"  		javaType="java.lang.String"   	mode="IN"/>
	 </parameterMap>

	<insert id="insertScheduleJob" parameterMap="Insert-ScheduleJob-Parm-Map">
		INSERT INTO schedule_job (idschedule_job,action,comments ) 
		VALUES (?,?,?)
	</insert>

	 <parameterMap id="Insert-JobInputs-Parm-Map"   class="java.util.HashMap">
		<parameter property="ScheduleID" 		javaType="java.lang.Integer"    mode="IN"/>	 
	    <parameter property="InputParmName" 	javaType="java.lang.String"    mode="IN"/>	    
		<parameter property="InputParmValue"  	javaType="java.lang.String"   	mode="IN"/>
	 </parameterMap>

	<insert id="insertJobInputs" parameterMap="Insert-JobInputs-Parm-Map">
		INSERT INTO job_inputs (idschedule_job, input_parmeter_name,input_paramenter_id ) 
		VALUES (?,?,?)
	</insert>
	<parameterMap id="Menu-Item-Map"   class="java.util.HashMap">
	    <parameter property="UserRole"    		javaType="java.lang.String"    mode="IN"/>
	 </parameterMap>

	<select id="getMenuItems" parameterMap="Menu-Item-Map" resultClass="java.util.HashMap">
           select menu_name, menu_url from menu_to_role_mapping where role = ?;
 	</select>

	<delete id="deleteAddress" >
		delete from address where personID = #idPerson#
	</delete>
	
	<insert id="insertDoctor" >
			insert into doctor_details (idPerson) values
			(#idPerson#);
	</insert>
	
	<insert id="insertPatient" >
			insert into patient_details (idPerson) values
			(#idPerson#);
	</insert>
	
	<update id="updateDoctorDetails" >
		UPDATE doctor_details set specialization=#doctorDetails.specialization#,registration_id=#doctorDetails.registrationNumber#,
		monday_working=#doctorDetails.mondayWorking#,tuesday_working=#doctorDetails.tuesdayWorking#,
		wednesday_working=#doctorDetails.wednesdayWorking#,thursday_working=#doctorDetails.thursdayWorking#,
		friday_working=#doctorDetails.fridayWorking#,saturday_working=#doctorDetails.saturdayWorking#,
		sunday_working=#doctorDetails.sundayWorking#
		where idPerson = #idPerson#;	
	</update>

	 <parameterMap id="Insert-DoctorWorkTimings-Parm-Map"   class="java.util.HashMap">
	    <parameter property="WorkDay"   			javaType="java.lang.String"   	mode="IN"/>
	    <parameter property="StartTime" 			javaType="java.util.Date"    	mode="IN"/>
		<parameter property="EndTime"   			javaType="java.util.Date"   	mode="IN"/>	    
		<parameter property="DoctorID"   			javaType="java.lang.Integer"   	mode="IN"/>			    
	 </parameterMap>

	<insert id="insertDoctorWorkTimings"  parameterMap="Insert-DoctorWorkTimings-Parm-Map">
			insert into doctor_work_timings (work_day,start_time,end_time,doctor_id) values
			(?,?,?,?);
	</insert>

	 <parameterMap id="Docotor-WorkTimings-Parm-Map"   class="java.util.HashMap">
		 <parameter property="PersonID"    	 		javaType="java.lang.Integer"    mode="IN"/>
	 </parameterMap>
	 
	 <resultMap class="com.mediapp.domain.common.DoctorWorkTimings" id="Doctor-WorkTimings-Result-Map">
	 	<result property="workDayName" 	column="work_day" />
	 	<result property="startTime" 	column="start_time" />
	 	<result property="endTime" 		column="end_time" />
	 </resultMap>

	<select id="getDoctorWorkTimings" parameterMap="Docotor-WorkTimings-Parm-Map" resultMap="Doctor-WorkTimings-Result-Map">
		select work_day,start_time, end_time 
		from doctor_work_timings dwt,
		doctor_details dd,
		person p
		where dwt.doctor_id = dd.iddoctor_details
		and dd.idperson = p.idperson
		and p.idPerson =?;

	</select>

	<delete id="deleteDoctorWorkTimings" >
		delete from doctor_work_timings where doctor_id = #doctorDetails.idDoctor#;
	</delete>

	
</sqlMap>