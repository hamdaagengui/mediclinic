<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC "-//iBATIS.com//DTD SQL Map 2.0//EN" "http://www.ibatis.com/dtd/sql-map-2.dtd">
<!--
	iBATIS SQL object - Relational mapping for Concurrent Data
	Includes SQL features: SELECT  -->
	

<sqlMap namespace="common">

	 <parameterMap id="Person-Details-Map"   class="java.util.HashMap">
	    <parameter property="Key"    	 		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Username"  		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="PersonType"   		javaType="java.lang.String"    mode="IN"/>	    
	 </parameterMap>
	 
	 <resultMap class="com.mediapp.domain.common.Person" id="Person-Details-Result-Map">
	 	<result property="idPerson" column="idPerson"/>
	 	<result property="firstName" column="first_name"/>
	 	<result property="lastName" column="last_name"/>
	 	<result property="middleInitial" column="middle_name"/>
	 	<result property="dateOfBirth" column="date_of_birth"/>
	 	<result property="gender" column="gender"/>
	 	<result property="landlinePhoneNumber" column="landline_phone_number"/>
	 	<result property="cellPhoneNumber" column="mobile_phone_number"/>
	 	<result property="emailID" column="email_address"/>
	 	<result property="accountStatus" column="status_of_account"/>
	 	<result property="personTypeString" column="person_type"/>
	 	<result property="password" column="ePassword"/>
	 	<result property="address.address1" column="address1" />
	 	<result property="address.address2" column="address2" />
	 	<result property="address.locality" column="locality" />
	 	<result property="address.city" column="city" />
	 	<result property="address.state" column="state" />
	 	<result property="address.country" column="country"/>
	 </resultMap>

	<select id="authenticateUser" parameterMap="Person-Details-Map" resultMap="Person-Details-Result-Map">
            SELECT person.idPerson,first_name,last_name,middle_name,
           date_of_birth, Gender, landline_phone_number, mobile_phone_number,
           email_address, status_of_account, person_type, AES_DECRYPT(password,?) as ePassword,
           address1, address2, locality, city, state, country
           FROM person left join address on address.personID = person.idPerson
           where 
		   email_address = ? and
		   person_type = ?;		   
 	</select>


	 <parameterMap id="Person-Type-Map"   class="java.util.HashMap">
	    <parameter property="Category"    		javaType="java.lang.String"    mode="IN"/>
	 </parameterMap>

	<select id="getPersonType" parameterMap="Person-Type-Map" resultClass="java.lang.String">
           SELECT code_val FROM code_decode where code_ctg = ?
 	</select>
	

	 <parameterMap id="eMail-Exists-Map"   class="java.util.HashMap">
	    <parameter property="emailID"    		javaType="java.lang.String"    mode="IN"/>
	 </parameterMap>


	<select id="checkeMailExists" parameterMap="eMail-Exists-Map" resultClass="java.lang.Integer">
           SELECT count(email_Address) FROM person where email_Address = ?
 	</select>


	<insert id="insertNewPerson">
		INSERT INTO person (idPerson, email_Address,status_of_account,person_type,password ) 
		VALUES (nextval('seq_person_id'), #emailID#,'T',#personTypeString#,AES_ENCRYPT(#password#,#key#) )
	</insert>
	
	<update id="updateProfile" >
		UPDATE person set first_name=#firstName#,last_name=#lastName#,middle_name=#middleInitial#,
		date_of_birth=date_format(#dateOfBirth#, '%y-%m-%d'),gender=#gender#,landline_phone_number=#landlinePhoneNumber#,mobile_phone_number=#cellPhoneNumber#
		where email_address=#username#
		and person_type=#personTypeString#	
	</update>
	
	<insert id="insertAddress" >
			insert into address (address1, address2, locality, city, state, country, personID) values
			(#address.address1#, #address.address2#, #address.locality#, #address.city#, #address.state#, #address.country#, currval('seq_person_id'))
			ON DUPLICATE KEY UPDATE updated = updated + 1;
	</insert>

 	<resultMap class="com.mediapp.domain.common.CodeDecode" id="Auto-Complete-Result-Map">
	 	<result property="codeDecode" column="code_val"/>
	 	<result property="codeDescription" column="code_desc"/>
	</resultMap>
	 	
	<parameterMap id="Auto-Complete-Map"   class="java.util.HashMap">
		<parameter property="Category"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Code"    		javaType="java.lang.String"    mode="IN"/>
	</parameterMap>

	<select id="autoComplete" parameterMap="Auto-Complete-Map" resultMap="Auto-Complete-Result-Map">
           SELECT code_val,code_desc FROM code_decode where code_ctg = ? and code_val like ?
 	</select>
 	
 	<resultMap class="com.mediapp.domain.common.SearchResult" id="Search-Result-Map">
 		<result property="idPerson" column="idPerson"/>
	 	<result property="doctorFirstName" column="first_name"/>
	 	<result property="doctorMiddleName" column="middle_name"/>
	 	<result property="doctorLastName" column="last_name"/>
	 	<result property="address1" column="address1"/>
	 	<result property="address2" column="address2"/>
	 	<result property="locality" column="Locality"/>
	 	<result property="city" column="City"/>
	 	<result property="state" column="State"/>
	 	<result property="country" column="Country"/>
	 	<result property="workStartTime" column="work_start_time"/>
	 	<result property="workEndTime" column="work_end_time"/>
	 	<result property="mondayWorking" column="monday_working"/>
	 	<result property="tuesdayWorking" column="tuesday_working"/>
	 	<result property="wednesdayWorking" column="wednesday_working"/>
	 	<result property="thursdayWorking" column="thursday_working"/>
	 	<result property="fridayWorking" column="friday_working"/>
	 	<result property="saturdayWorking" column="saturday_working"/>
	 	<result property="sundayWorking" column="sunday_working"/>	 	
	</resultMap>
	 	
	<parameterMap id="Search-Input-Map"   class="java.util.HashMap">
		<parameter property="MondayWorking"    	javaType="java.lang.String"    mode="IN"/>
		<parameter property="MondayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="TuesdayWorking"    javaType="java.lang.String"    mode="IN"/>
	    <parameter property="TuesdayWorking"    javaType="java.lang.String"    mode="IN"/>
	    <parameter property="WednesdayWorking"  javaType="java.lang.String"    mode="IN"/>
	    <parameter property="WednesdayWorking"  javaType="java.lang.String"    mode="IN"/>
	    <parameter property="ThursdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="ThursdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FridayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FridayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SaturdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SaturdayWorking"   javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SundayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="SundayWorking"    	javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Locality"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="Locality"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FirstName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="FirstName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="LastName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="LastName"    		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="MiddleInitial"		javaType="java.lang.String"    mode="IN"/>
	    <parameter property="MiddleInitial"		javaType="java.lang.String"    mode="IN"/>	    
	</parameterMap>

	<select id="searchDoctor" parameterMap="Search-Input-Map" resultMap="Search-Result-Map">
			select p.idPerson, p.first_name,p.last_name, p.middle_name,
			dd.work_start_time, dd.work_end_time,
			monday_working, tuesday_working,
			wednesday_working, thursday_working,
			friday_working, saturday_working,
			sunday_working, address1,address2, Locality, City,State,Country
			from 
			person p,
			doctor_details dd,
			address a
			where p.idPerson = dd.idPerson
			and p.idPerson = a.personID			
			and (dd.monday_working = ? or ifnull(?,'')='')
            and (dd.tuesday_working  = ? or ifnull(?,'')='')
            and (dd.wednesday_working = ? or ifnull(?,'')='')
            and (dd.thursday_working = ? or ifnull(?,'')='')
            and (dd.friday_working = ? or ifnull(?,'')='')
            and (dd.saturday_working = ? or ifnull(?,'')='')
            and (dd.sunday_working = ? or ifnull(?,'')='')
            and (Locality =? or ifnull(?,'')='')
    		and (first_name = ? or ifnull(?,'')='')
    		and (last_name = ? or ifnull(?,'')='')
    		and (middle_name = ? or ifnull(?,'')='')        
            and person_type = 'Doctor' 	
      </select>

 	<resultMap class="com.mediapp.domain.common.Appointment" id="Day-Appointment-Result-Map">
	 	<result property="headline" 			column="appointment_headline"/>
	 	<result property="dateOfAppointment" 	column="date_of_appointment"/>
	 	<result property="timeOfAppointment" 	column="time_of_appointment"/>
	 	<result property="appointmentDuration" 	column="appointment_duration"/>
	 	<result property="doctorID" 			column="idDoctor_details"/>
	</resultMap>
	 	
	<parameterMap id="Day-Appointment-Parm-Map"   class="java.util.HashMap">
		<parameter property="PersonID"    			javaType="java.lang.Integer"   mode="IN"/>
	    <parameter property="DateOfAppointment"    	javaType="java.util.Date"   		mode="IN"/>
	    <parameter property="PersonID"    			javaType="java.lang.Integer"    mode="IN"/>
	</parameterMap>

	<select id="dayAppointment" parameterMap="Day-Appointment-Parm-Map" resultMap="Day-Appointment-Result-Map">
			select appointment_headline,date_of_appointment,time_of_appointment, appointment_duration,ah.idDoctor_details
			from appointment_history ah,
			doctor_details dd,
			person p
			where 
			(p.person_type = 'Doctor' and dd.idPerson=p.idPerson and dd.idDoctor_details = ah.idDoctor_details) 
			and p.idPerson =?
			and date_of_appointment = date_format(?,'%Y-%m-%d')
			 union all
			select '','9999-12-31','23:59:59', '23:59:59',idDoctor_details
			from doctor_details dd,
			person p
			where 
			(p.person_type = 'Doctor' and dd.idPerson=p.idPerson) 
			and p.idPerson =?
 	</select>

	<parameterMap id="Day-Appointment-Parm-Map"   class="java.util.HashMap">
		<parameter property="PersonID"    			javaType="java.lang.Integer"    mode="IN"/>	    
	</parameterMap>
	
	<insert id="insertNewAppointment">
		INSERT INTO appointment_history ( idPatient_details,idDoctor_details,date_of_appointment,appointment_type,
		appointment_confirmation,time_of_appointment,appointment_comment,appointment_duration,appointment_headline ) 
		VALUES ( (select idpatient_details from patient_details where idPerson=#doctorPersonID#),#doctorID#,#dateOfAppointment#,'R','N',
		#timeOfAppointment#,#comments#,#appointmentDuration# ,#headline#)
	</insert>
</sqlMap>